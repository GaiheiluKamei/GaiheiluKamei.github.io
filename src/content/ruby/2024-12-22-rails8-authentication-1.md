---
title: Rails 8 Authentication å®ç°åˆ†æ(1) - ç†è®ºå‡†å¤‡
publishedAt: 2024-12-22
---

åå¤©å‰ï¼Œ37signals å‘å¸ƒäº†ä¸€ç¯‡æ–‡ç« ï¼š**A vanilla Rails stack is plenty**ï¼Œè¿™ç¯‡æ–‡ç« åŠ å¼ºäº†æˆ‘ä¸€ç›´ä»¥æ¥çš„æƒ³æ³•ï¼š**å¦‚æœ Rails æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œé‚£ä¹ˆæœ€å¥½åšæŒ Rails çš„æ–¹æ¡ˆ**ã€‚ä¿æŒæœ€å°çš„ä¾èµ–æ€§ã€å‡å°‘ç‰ˆæœ¬å‡çº§çš„éšœç¢å›ºç„¶é‡è¦ï¼›æ›´é‡è¦çš„æ˜¯å­¦ä¹ é¡¶çº§å¼€å‘äººå‘˜æ€è€ƒã€å®è·µä¹‹åçš„â€œæœ€ä¼˜è§£â€ã€‚

æ‰€ä»¥å½“ Rails 8 æ¨å‡º Authentication æ–¹æ¡ˆæ—¶ï¼Œæˆ‘æƒ³åœ¨ç¬¬ä¸€æ—¶é—´å­¦ä¹ ä»–çš„å®ç°ç»†èŠ‚ï¼Œä¹Ÿå€Ÿæ­¤æœºä¼šäº†è§£èº«ä»½éªŒè¯è¿™ä¸ªæˆ‘ä¸€å‘è§‰å¾—ç¥ç§˜çš„é»‘ç›’ã€‚

> **A vanilla Rails stack is plenty**: [https://dev.37signals.com/a-vanilla-rails-stack-is-plenty/](https://dev.37signals.com/a-vanilla-rails-stack-is-plenty/)

## 1. å¯†ç åº”è¯¥å¦‚ä½•ä¿å­˜

è¦äº†è§£èº«ä»½éªŒè¯ï¼Œé¦–å…ˆè¦ç¡®å®šåœ¨å¼€å‘ä¸­åº”è¯¥å¦‚ä½•ä¿å­˜å¯†ç ã€‚æœ‰å››ç§å¯èƒ½çš„æ–¹å¼ï¼š**æ˜æ–‡**ã€**å“ˆå¸Œ (Hashing)**ã€**åŠ å¯† (Encrypting)**ã€**ç­¾å (Signing)**ï¼Œä¸‹é¢åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™å››ç§ä½ å¯èƒ½å·²ç»éƒ½äº†è§£çš„æ–¹æ¡ˆã€‚

### 1.1 æ˜æ–‡

æ‰€è°“æ˜æ–‡ä¿å­˜ç”¨æˆ·å¯†ç ï¼Œå°±æ˜¯ç”¨æˆ·çš„å¯†ç æ˜¯ä»€ä¹ˆæˆ‘ä»¬å°±åœ¨æ•°æ®åº“ä¸­ä¿å­˜ä»€ä¹ˆã€‚è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯ç›¸å½“ä¸€ç›®äº†ç„¶çš„ï¼Œè€Œä¼˜ç‚¹å¯ä»¥è¯´æ˜¯æ²¡æœ‰ï¼š

- å¦‚æœæ•°æ®åº“è¢«é»‘å®¢æ”»å‡»ï¼Œé‚£ä¹ˆç”¨æˆ·åã€å¯†ç ä¸€èµ·æ³„éœ²...æƒ³ä¸€æƒ³é»‘å®¢æ‹¿åˆ°ä½ çš„æ”¯ä»˜å®è´¦å·ã€å¯†ç çš„åœºæ™¯
- å³ä½¿æ²¡æœ‰è¢«é»‘å®¢æ”»å‡»ï¼Œå†…éƒ¨å¼€å‘äººå‘˜ä¹Ÿèƒ½ç›´æ¥é€šè¿‡æ•°æ®åº“çœ‹åˆ°ç”¨æˆ·çš„å¯†ç ï¼Œè¿™å’Œè¢«æ”»å‡»çš„åŒºåˆ«ä¸å¤§

### 1.2 åŠ å¯† (Encrypting)

åŠ å¯†å°±æ˜¯æŠŠç»™å®šçš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¹±ç å­—ç¬¦ä¸²çš„è¿‡ç¨‹ã€‚å®ƒçš„é—®é¢˜åœ¨äº**åªè¦ä½ æœ‰åŠ å¯†å¯†é’¥ï¼ŒåŠ å¯†å°±æ˜¯å¯é€†çš„**ï¼Œæ‰€ä»¥è°æ¥ä¿å­˜è¿™ä¸ªå¯†é’¥å‘¢ï¼ŸDBAã€CTOã€CEOã€UFOï¼Ÿ

ä¿å­˜å¯†é’¥æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æŒ‘æˆ˜ï¼Œæ˜¾ç„¶è¿™ä¸ªæ–¹æ¡ˆä¹Ÿä¸å¯å–ã€‚

### 1.3 ç­¾å (Signing)

ç­¾åæ˜¯åˆ©ç”¨éå¯¹ç§°åŠ å¯†æŠ€æœ¯ç”Ÿæˆä¸€ä¸ªç§é’¥å’Œä¸€ä¸ªå…¬é’¥ç»„æˆçš„å¯†é’¥å¯¹ï¼Œç”¨ç§é’¥ä¸ºæ•°æ®åˆ›å»ºç­¾åï¼Œè€Œä½¿å¾—æ‹¥æœ‰ç›¸åº”å…¬é’¥çš„ä»»ä½•äººéƒ½å¯ä»¥éªŒè¯ç­¾åï¼Œå®ƒä¸»è¦ç”¨æ¥éªŒè¯æ•°æ®çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯**æ•°æ®æœ¬èº«å¹¶æ²¡æœ‰è¢«åŠ å¯†ï¼Œåªæ˜¯å¸¦æœ‰ä½ çš„ç§é’¥ç­¾å**ã€‚æ‰€ä»¥ä»”ç»†æƒ³ä¸€æƒ³ï¼Œç”¨æ¥éªŒè¯æ•°æ®çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ç¡®å®æ˜¯ä¸é”™çš„ï¼Œä½†ç”¨æ¥åŠ å¯†å°±ä¸åˆç†äº†ï¼Œå› ä¸º**æ•°æ®æœ¬èº«è¿˜æ˜¯ç›¸å½“äºæ˜æ–‡å­˜å‚¨**çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Rails ä¸­ç”¨ `ActiveSupport::MessageVerifier` ç±»æ¥éªŒè¯ï¼š

```ruby
# 1. è¿™æ˜¯ä½ çš„ç§é’¥
verifier = ActiveSupport::MessageVerifier.new("secret key")

# 2. ä½ ç”¨ç§é’¥ç­¾åç”¨æˆ·çš„å¯†ç 
signed_string = verifier.generate("user's password")
# => "InVzZXIncyBwYXNzd29yZCI=--8c5d09fcec50a63bad5ffe303a307be10d412615"

# 3. è¿™ä¸ªç­¾åçš„ç»“æœä¼¼ä¹éå¸¸ä¸é”™ï¼Œçœ‹èµ·æ¥åƒè¢«åŠ å¯†äº†ï¼Œè€Œä¸”è¿˜å¯ä»¥è¢«éªŒè¯
verifier.verify("InVzZXIncyBwYXNzd29yZCI=--8c5d09fcec50a63bad5ffe303a307be10d412615")
# => "user's password"

# 4. ä½†ä¸è¦è¢«è¿™ä¸ªå­—ç¬¦ä¸²çš„è¡¨é¢æ‰€è¿·æƒ‘ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²ä»¥ `--` åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå‰åŠéƒ¨åˆ†æ˜¯ payloadï¼Œæ˜¯å…¬å¼€çš„ï¼Œ
# åªæ˜¯ç”¨ Base64 è¿›è¡Œäº†ç¼–ç ï¼› ååŠéƒ¨åˆ†æ‰æ˜¯ç­¾å
payload, signature = signed_string.split("--")

# 5. æ•°æ®éƒ¨åˆ†æ˜¯å…¬å¼€çš„ï¼Œä¹Ÿå°±æ˜¯ä½ é‡‡ç”¨è¿™ç§æ–¹æ¡ˆï¼Œç›¸å½“äºç”¨æˆ·å¯†ç æ˜¯å…¬å¼€çš„
JSON.parse(Base64.decode64(payload))
# => "user's password"

# 6. ä½†ç­¾åæ˜¯ç§å¯†çš„ï¼Œå¦‚æœæ›´æ”¹äº†æ•°æ®éƒ¨åˆ†ï¼Œä¼šå¯¼è‡´éªŒè¯å¤±è´¥ï¼Œæ‰€ä»¥ç­¾åèƒ½ä¿è¯æ•°æ®çš„å®Œæ•´æ€§
bad_payload = Base64.encode64("fake data").strip
# => "ZmFrZSBkYXRh"
bad_signed_string = [bad_payload, signature].join("--")
# => "ZmFrZSBkYXRh--8c5d09fcec50a63bad5ffe303a307be10d412615"
verifier.verify(bad_signed_string)
# raises ActiveSupport::MessageVerifier::InvalidSignature
```

`ActiveSupport::MessageVerifier` ä½¿ç”¨çš„å¯†é’¥æ¥è‡ª `secret_key_base`ï¼Œè¿™ä¸ªé…ç½®åœ¨ Rails 6+ ç‰ˆæœ¬ä¸­ä½äº `config/credentials.yml.enc`ï¼ŒRails çš„ `cookies.signed` å°±æ˜¯åˆ©ç”¨è¿™ç§æ–¹å¼æ¥éªŒè¯â€œæµè§ˆå™¨ä¼ è¿‡æ¥çš„ cookie ç¡®å®æ˜¯ä½ å‘å‡ºå»çš„ cookieâ€ã€‚

### 1.4 å“ˆå¸Œ (Hashing)

å“ˆå¸Œæ˜¯æŠŠç»™å®šçš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå›ºå®šå¤§å°çš„ä¹±ç å­—ç¬¦ä¸²ï¼Œå®ƒæœ‰ä¸¤ä¸ªå¾ˆæ£’çš„ç‰¹æ€§ï¼š

- **ç¡®å®šæ€§**ï¼šç»™å®šçš„è¾“å…¥æ€»æ˜¯ä¼šè¢«è½¬æ¢ä¸ºç›¸åŒçš„å“ˆå¸Œå€¼
- **ä¸å¯é€†**ï¼šå“ˆå¸Œå‡½æ•°æ˜¯å•å‘çš„ï¼Œåœ¨è®¡ç®—ä¸Šä»å“ˆå¸Œå€¼åæ¨å‡ºåŸå§‹è¾“å…¥æ˜¯ä¸å¯è¡Œçš„

è¿™ç®€ç›´æ˜¯ä¸ºä¿å­˜å¯†ç é‡èº«å®šåˆ¶çš„ï¼Œæˆ‘ä»¬é€šè¿‡å“ˆå¸Œç®—æ³•æŠŠç”¨æˆ·çš„å¯†ç è½¬ä¸ºå“ˆå¸Œå€¼ï¼Œå³ä½¿æ•°æ®åº“è¢«æ”»å‡»ã€å³ä½¿å†…éƒ¨äººå‘˜æ‹¿åˆ°å“ˆå¸Œå€¼ä¹Ÿæ— æ³•å¾—åˆ°ç”¨æˆ·çš„åŸå§‹å¯†ç ã€‚åœ¨ `rails console` ä¸­å°è¯•ä¸€ä¸‹ï¼š

```ruby
Digest::SHA256.hexdigest("hello")
# => "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824"
```

æœ‰å¾ˆå¤šå“ˆå¸Œç®—æ³•ï¼Œå¦‚ä¼—æ‰€å‘¨çŸ¥çš„ SHA1ã€SHA256ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„å“ˆå¸Œç®—æ³•éƒ½é€‚åˆå¤„ç†ç”¨æˆ·å¯†ç ã€‚äº‹å®ä¸Šï¼ŒSHA256 è¿™äº›æ°¸è¿œéƒ½ä¸åº”è¯¥è¢«ç”¨æ¥å“ˆå¸Œç”¨æˆ·å¯†ç ï¼Œå› ä¸ºå®ƒä»¬â€œå¤ªå¿«äº†â€ï¼Œå¾ˆå®¹æ˜“è¢«**æš´åŠ›æ”»å‡» (brute force attack)**ï¼Œæš´åŠ›æ”»å‡»æ˜¯æŒ‡æ”»å‡»è€…å¯¹å¾ˆå¤šéšæœºå­—ç¬¦ä¸²é€ä¸ªè¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œä»¥å°è¯•å…¶ä¸­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦å’Œå¯†ç çš„å“ˆå¸Œå€¼åŒ¹é…ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§æƒ…å†µä¸‹ç®—æ³•è¶Šå¿«ï¼Œé»‘å®¢å°±è¶Šå®¹æ˜“ç ´è§£åˆ°å¯†ç ã€‚

è¦ä¿å­˜ç”¨æˆ·å¯†ç ï¼Œå¿…é¡»ä½¿ç”¨ä¸“é—¨ä¸ºç”Ÿæˆç”¨æˆ·å¯†ç è®¾è®¡çš„å“ˆå¸Œç®—æ³•ï¼Œè¿™ç§ç®—æ³•è¢«ä¸“é—¨è®¾è®¡æˆâ€œé€Ÿåº¦æ…¢ã€æ¶ˆè€—å¤§é‡å†…å­˜â€ï¼Œæ¯”å¦‚ Rails é»˜è®¤ä½¿ç”¨çš„ Bcrypt ç®—æ³•ã€‚Bcrypt è¿˜å¯ä»¥é€šè¿‡**æˆæœ¬å› å­ (cost factor)** æ¥æ§åˆ¶é€Ÿåº¦å’Œå†…å­˜æ¶ˆè€—ï¼Œæˆæœ¬å› å­è¶Šé«˜ï¼Œå“ˆå¸Œè®¡ç®—è¶Šæ…¢ã€‚æœ‰ä¸€äº›æ–°å‹çš„è¿™ç±»ç®—æ³•å®‰å…¨æ€§æ›´é«˜ï¼Œæ¯”å¦‚ Argon2idï¼Œä½† Bcrypt çš„æˆæœ¬å› å­è®¾ç½®ä¸º 10 åŠä»¥ä¸Šéƒ½æ˜¯å®‰å…¨çš„ï¼ŒRails çš„é»˜è®¤å€¼æ˜¯ 12ã€‚

ä¸è¿‡è¿™è¿˜ä¸å¤Ÿï¼Œå¦‚æœæ”»å‡»è€…å·²ç»æœ‰äº†ä¸€ä¸ªå·¨å¤§çš„å­—ç¬¦ä¸²æ•°æ®åº“ä¿å­˜ç€å­—ç¬¦ä¸²åˆ°å“ˆå¸Œå€¼çš„æ˜ å°„ï¼Œé‚£ä¹ˆä»–ä»¬åªéœ€è¦æŸ¥è¯¢è¿™ä¸ªæ•°æ®åº“å°±èƒ½å¾—åˆ°åŸå§‹å¯†ç ï¼Œè¿™ç§æ•°æ®åº“è¢«ç§°ä¸º **å½©è™¹è¡¨ (rainbow tables)**ï¼Œè¿™ç§æ”»å‡»è¢«ç§°ä¸º **å½©è™¹è¡¨æ”»å‡» (rainbow table attack)**ã€‚è¦é˜²æ­¢å½©è™¹è¡¨æ”»å‡»ï¼Œéœ€è¦å¯¹å¯†ç **åŠ ç› (salting)**ï¼šæ‰€è°“åŠ ç›å°±æ˜¯åœ¨ä¿å­˜ç”¨æˆ·å¯†ç æ—¶ï¼Œéšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒæŠŠè¿™ä¸ªå­—ç¬¦ä¸²å’Œç”¨æˆ·å¯†ç â€œè¿æ¥â€åˆ°ä¸€èµ·è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œè¿™æ ·å°±ç®—ä¸¤ä¸ªç”¨æˆ·çš„å¯†ç ç›¸åŒï¼Œä½†å› ä¸ºæ¯ä¸ªäººçš„â€œç›å€¼â€ä¸åŒï¼Œä»–ä»¬è¢«ä¿å­˜çš„çš„å“ˆå¸Œå€¼ä¹Ÿä¸ç›¸åŒã€‚è¿™å°±ä½¿å¾—è™½ç„¶é»‘å®¢çš„æ•°æ®åº“é‡Œä¿å­˜çš„å¯†ç  `123` çš„å“ˆå¸Œå€¼ä¸º `xxx` (å‡è®¾)ï¼Œä½†é€šè¿‡åŠ ç›æ“ä½œä½¿å¾— `123` çš„å“ˆå¸Œå€¼å˜æˆäº† `xxy`ï¼Œè¿™å°±ä½¿å¾—å‡ ä¹ä¸å¯èƒ½ä½¿ç”¨å½©è™¹è¡¨æ”»å‡»æ¥ç ´è§£ç”¨æˆ·å¯†ç ã€‚

Rails çš„åŠ ç›æ“ä½œæ˜¯é€šè¿‡ `has_secure_password` è‡ªåŠ¨å®Œæˆçš„ï¼š

1. å½“åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·æ—¶ï¼ŒRails è‡ªåŠ¨**ä¸ºè¿™ä¸ªç”¨æˆ·ç”Ÿæˆä¸€ä¸ªéšæœºçš„ç› (salt)**
2. Rails ä½¿ç”¨ Bcrypt æŠŠç”¨æˆ·çš„å¯†ç å’Œç›ç»“åˆèµ·æ¥ç”Ÿæˆå“ˆå¸Œå€¼
3. ç”Ÿæˆçš„å“ˆå¸Œå€¼è¢«ä¿å­˜åœ¨ç”¨æˆ·çš„ `xxx_digest` å­—æ®µä¸­ï¼Œè¿™é‡Œçš„ `xxx` ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨ `password`

å½“ç”¨æˆ·ç™»å½•éœ€è¦éªŒè¯å¯†ç æ—¶ï¼ŒRails ä½¿ç”¨ `authenticate` æ–¹æ³•å®Œæˆä»¥ä¸‹æ“ä½œï¼š

1. é€šè¿‡é‚®ç®±ç­‰ç”¨æˆ·åæŸ¥æ‰¾å¯¹åº”çš„ `password_digest` å“ˆå¸Œå€¼
2. Bcrypt ä» `password_digest` ä¸­æå–ç›ä»¥åŠå“ˆå¸Œå€¼æœ¬èº«
3. Bcrypt ç”¨ç”¨æˆ·è¾“å…¥çš„å¯†ç å’Œæå–å‡ºæ¥çš„ç›é‡æ–°ç”Ÿæˆä¸€ä¸ªå“ˆå¸Œå€¼
4. Bcrypt æ¯”è¾ƒæ–°ç”Ÿæˆçš„å“ˆå¸Œå€¼å’Œä¿å­˜åœ¨ `password_digest` ä¸­çš„å“ˆå¸Œå€¼æ˜¯å¦ä¸€æ ·ï¼Œå¦‚æœä¸€æ ·ï¼Œåˆ™éªŒè¯é€šè¿‡

OWASP çš„ **Password Storage Cheat Sheet** éƒ¨åˆ†å¯¹ä¿å­˜å¯†ç ç›¸å…³çš„å“ˆå¸Œç®—æ³•æœ‰ç›¸å½“å®Œæ•´çš„è§£é‡Šï¼Œä¸è¿‡é™¤äº†åŠ ç›ä¹‹å¤–ï¼Œè¿˜æœ‰**åŠ èƒ¡æ¤’ (peppering)** è¿™ç§æ“ä½œæ˜¯æˆ‘å®Œå…¨æ²¡æœ‰æ–™åˆ°çš„ã€‚ğŸ¥²

> Password Storage Cheat Sheet: [https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)

## 2. åœ¨ Rails Console ä¸­å°è¯•ç‰›åˆ€

### 2.1 å­¦ä¸€ç‚¹ Yaml

åœ¨ Rails 8 é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ `rails g authentication` ä¹‹åï¼Œè™½ç„¶å¯ä»¥ç›´æ¥æ‰“å¼€ `bin/rails console` è¿›è¡Œåˆ›å»ºç”¨æˆ·æ“ä½œï¼Œä½†è¿™é‡Œæˆ‘æƒ³é¡ºä¾¿è®°å½•ä¸¤ä¸ªåœ¨ *fixtures* ä¸­æå–å˜é‡çš„æŠ€å·§ã€‚

ç¬¬ä¸€ä¸ªæ˜¯åˆ©ç”¨ ERB æå–å˜é‡ï¼š

```yml
# test/fixtures/users.yml

<% password_digest = BCrypt::Password.create("password") %>

one:
  email_address: one@example.com
  password_digest: <%= password_digest %>

two:
  email_address: two@example.com
  password_digest: <%= password_digest %>
```

ç¬¬äºŒä¸ªæ˜¯åˆ©ç”¨ Yaml çš„**é”šç‚¹ (anchors)** å’Œ**åˆ«å (aliases)**ï¼š

```yml
# test/fixtures/users.yml

DEFAULTS: &defaults
  password_digest: <%= BCrypt::Password.create("password") %>

one:
  email_address: one@example.com
  <<: *defaults

two:
  email_address: two@example.com
  <<: *defaults
```

è¿™ä¸ªå†™æ³•åœ¨ `config` ç›®å½•çš„ Yaml é…ç½®æ–‡ä»¶ä¸­å¾ˆå¸¸è§ï¼Œæˆ‘ä¹‹å‰ä¸€ç›´ä¼¼æ‡‚éæ‡‚ã€‚å…¶å®å¾ˆç®€å•ï¼š

1. ç”¨ `&` å®šä¹‰ä¸€ä¸ªé”šç‚¹ï¼Œè¿™ä¸ªé”šç‚¹åŒ…å«äº† `password_digest` è¿™ä¸ªé”®å€¼å¯¹
2. ç”¨ `*` å¼•ç”¨è¿™ä¸ªé”šç‚¹ï¼Œç›¸å½“äºæŠŠé”šç‚¹ä¸‹çš„æ‰€æœ‰å€¼éƒ½æ’å…¥åˆ°å¼•ç”¨çš„ä½ç½®
3. `<<` è¢«ç§°ä¸º**åˆå¹¶é”® (Merge Key)**ï¼Œç»å¸¸å’Œ `*` ä¸€èµ·ä½¿ç”¨ï¼ŒæŠŠä¸€ä¸ªé”šç‚¹çš„å†…å®¹åˆå¹¶åˆ°å½“å‰èŠ‚ç‚¹ï¼Œè€Œä¸”å…è®¸ä½¿ç”¨æ–°çš„å€¼è¦†ç›–é”šç‚¹ä¸­çš„å€¼
4. å¦‚æœä¸ä½¿ç”¨åˆå¹¶é”®ï¼ŒYaml è§£æå™¨ä¼šç”¨æ•´ä¸ªé”šç‚¹çš„å†…å®¹ç›´æ¥æ›¿æ¢å½“å‰èŠ‚ç‚¹ï¼Œæ›¿æ¢è¿‡ç¨‹ä¸­å¦‚æœå­˜åœ¨é”®å†²çªï¼Œå¤§å¤šæ•°è§£æå™¨éƒ½ä¼šæŠ¥é”™

> **YAML anchors**: [https://support.atlassian.com/bitbucket-cloud/docs/yaml-anchors/](https://support.atlassian.com/bitbucket-cloud/docs/yaml-anchors/)

### 2.2 ä¸€ç‚¹ Rails å°æŠ€å·§

ç°åœ¨ `test/fixtures/users.yml` æ–‡ä»¶ä¸­å·²ç»æœ‰äº†ç»ƒæ‰‹éœ€è¦çš„æ•°æ®ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆæŠŠå®ƒå†™å…¥åˆ°æ•°æ®åº“ä»¥åœ¨ Rails Console ä¸­ä½¿ç”¨å‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼š

1. æŠŠæ•°æ®å†™å…¥æµ‹è¯•æ•°æ®åº“ï¼Œå†ä»¥æµ‹è¯•ç¯å¢ƒè¿è¡Œ Rails Consoleï¼š
   1. `bin/rails test`
   2. `RAILS_ENV=test bin/rails console`
2. æŠŠæ•°æ®å†™å…¥å¼€å‘æ•°æ®åº“ï¼Œå†ä»¥å¼€å‘ç¯å¢ƒè¿è¡Œ Rails Consoleï¼š
   1. `bin/rails db:fixtures:load`
   2. `bin/rails console`

æ— è®ºå“ªç§æ–¹å¼ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Rails Console æ¥å°è¯• Bcrypt ç®—æ³•äº†ã€‚

### 2.3 åœ¨ Rails Console ä¸­å°è¯•

```ruby
user = User.first
# =>  #<User:0x000070c0cf51c880...

# 1. password_digest åˆ—ç¡®å®æ˜¯ä»¥å“ˆå¸Œå­˜å‚¨çš„
user.password_digest
# => "$2a$12$cFn5jqnTfWVbQzxyfplWuexuKbhOw9fq9aKsNun5PU.GoORlaYqlG"

# 2. ä½¿ç”¨ BCrypt::Password.new åˆ›å»ºä¸€ä¸ª BCrypt::Password å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº†åŸå§‹
# å“ˆå¸Œå­—ç¬¦ä¸²çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›å€¼ã€æˆæœ¬å› å­å’Œå“ˆå¸Œå€¼æœ¬èº«
hash = BCrypt::Password.new(user.password_digest)
# => "$2a$12$cFn5jqnTfWVbQzxyfplWuexuKbhOw9fq9aKsNun5PU.GoORlaYqlG"

# 3. ç”±äº hash æ˜¯ç¡®å®šæ€§çš„ï¼Œæ‰€ä»¥å¯ä»¥å’Œç”¨æˆ·æä¾›çš„å¯†ç è¿›è¡Œæ¯”è¾ƒï¼Œæ³¨æ„ `==` æ˜¯ä¸€ä¸ªæ–¹æ³•
hash == "password"
# => true

# 4. å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ is_password? æ–¹æ³•
hash.is_password? "password"
# => true

# 5. äº†è§£å“ˆå¸Œå¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç®—æ³•ç‰ˆæœ¬ã€æˆæœ¬å› å­å’Œç›å€¼
hash.version
# => "2a"
hash.cost
# => 12
hash.salt
# => "$2a$12$cFn5jqnTfWVbQzxyfplWue"
```

è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ `BCrypt::Password.create` å’Œ `BCrypt::Password.new` çš„åŒºåˆ«ï¼š

1. `create` ç”¨äº**åˆ›å»º**æ–°çš„å“ˆå¸Œå€¼ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ˜æ–‡å¯†ç ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª Bcrypt å“ˆå¸Œå­—ç¬¦ä¸²
2. `new` ç”¨äº**éªŒè¯**ç°æœ‰çš„å“ˆå¸Œå€¼ï¼Œå®ƒæ¥å—ä¸€ä¸ª Bcrypt å“ˆå¸Œå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª `BCrypt::Password` å¯¹è±¡ï¼Œç”¨äºä¸ç”¨æˆ·æä¾›çš„å¯†ç è¿›è¡Œæ¯”è¾ƒ

æ³¨æ„ï¼Œ**æˆ‘ä»¬æ€»æ˜¯åº”è¯¥ç”¨ `BCrypt::Password` å¯¹è±¡æ¯”è¾ƒå“ˆå¸Œå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ç›´æ¥æ¯”è¾ƒå­—ç¬¦ä¸²**ã€‚è¿™é‡Œçš„ `==` æ–¹æ³•å°±å¾ˆæœ‰è¿·æƒ‘æ€§ï¼Œè®©äººä»¥ä¸ºåœ¨æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼›è€Œå®é™…ä¸Šæˆ‘ä»¬æ˜¯åœ¨è°ƒç”¨ `BCrypt::Password` å¯¹è±¡ä¸Šçš„ `==` æ–¹æ³•ã€‚

è¿˜å¯ä»¥è‡ªå·±é…ç½®æˆæœ¬å› å­ï¼Œè™½ç„¶å¤§æ¦‚ç‡ä¸éœ€è¦è¿™æ ·åšï¼š

```ruby
# config/initializers/bcrypt.rb

BCrypt::Engine.cost = 15
```

### 2.4 äº†è§£ `has_secure_password`

Authentication æ–¹æ¡ˆæœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯å»ºç«‹åœ¨ `has_secure_password` æ–¹æ³•ä¸Šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆéš¾ä¸å»äº†è§£è¿™ä¸ªæ–¹æ³•ã€‚ç²—ç•¥æ¥è¯´ï¼Œ`has_secure_password`ï¼š

1. éœ€è¦ä½ æŒ‡å®šä¸€ä¸ªè¦è¢«å“ˆå¸Œå­˜å‚¨çš„å±æ€§åï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤å°±æ˜¯ `:password`
2. æ ¹æ®å±æ€§åï¼Œå®ƒå¸®æˆ‘ä»¬åˆ›å»ºäº† `xxx_confirmation` å±æ€§ï¼Œè¿™ä¸ªå±æ€§ä¸€èˆ¬ç”¨æ¥åœ¨åˆ›å»ºå¯†ç æ—¶â€œå†æ¬¡è¾“å…¥å¯†ç â€ (ç”¨äºå®¢æˆ·ç«¯éªŒè¯ï¼Œå’Œå¯†ç å“ˆå¸Œæ— å…³)
3. å®ƒè¿˜åˆ›å»ºäº† `xxx_challenge` å±æ€§ï¼Œä¸€èˆ¬ç”¨æ¥éªŒè¯åœ¨ä¿®æ”¹å¯†ç æ—¶â€œè¾“å…¥çš„å½“å‰å¯†ç â€ (**ä¿®æ”¹å¯†ç æ—¶è¦æ±‚è¾“å…¥å½“å‰å¯†ç æ˜¯æå…¶å¿…è¦çš„**)
4. å®ƒç”¨ `generates_token_for` æ–¹æ³•ç”Ÿæˆäº†ä¸€ä¸ª`xxx_reset_token` æ–¹æ³•ï¼Œåè€…ç”Ÿæˆä¸€ä¸ªé»˜è®¤ 15 åˆ†é’Ÿè¿‡æœŸçš„é‡ç½®å¯†ç çš„ tokenï¼Œå¯ä»¥ç”¨ `find_xxx_reset_token` æ–¹æ³•è¿›è¡ŒéªŒè¯

å…¶ä¸­ `xxx_reset_token` ä¸­æ˜¯è¿™æ ·ä½¿ç”¨ `generates_token_for` çš„ï¼š

```ruby
# https://github.com/rails/rails/blob/cf6ff17e9a3c6c1139040b519a341f55f0be16cf/activemodel/lib/active_model/secure_password.rb#L163
generates_token_for :"#{attribute}_reset", expires_in: 15.minutes do
  public_send(:"#{attribute}_salt")&.last(10)
end
```

è¿™é‡Œç”¨ç›çš„æœ€å 10 ä¸ªå­—ç¬¦ä½œä¸ºé‡ç½®å¯†ç çš„ token çš„ä¸€éƒ¨åˆ†ï¼Œè™½ç„¶è¿™ 10 ä¸ªå­—ç¬¦ç›¸å½“äºæ˜æ–‡å­˜å‚¨çš„ï¼Œä½†ç”±äºå¯†ç é‡ç½®ä¹‹åç›ä¹Ÿä¼šå˜åŒ–ï¼Œæ‰€ä»¥ä½œä¸ºä¸€æ¬¡æ€§çš„ä½¿ç”¨æ˜¯å®‰å…¨çš„ (è™½ç„¶å®‰å…¨æ€§ç›¸å¯¹è¾ƒå¼±ï¼Œä½†ä¸€èˆ¬çš„å°ç ´ç«™æ¼æ´ç™¾å‡ºï¼Œå®ç°åŠŸèƒ½å·²å±ä¸æ˜“ï¼Œæ‹…å¿ƒè¿™ä¸ªæ›´æ˜¯å¤šä½™ ğŸ¤ª)ã€‚è€Œ `generates_token_for` æ–¹æ³•æœ¬èº«æ˜¯åŸºäºä¸Šè¿°çš„ `ActiveSupport::MessageVerifier` å®ç°çš„ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ­£å¦‚ DHH åœ¨ PR **rails#50446** æ‰€è¯´çš„ï¼š Rails now include all the key building blocks needed to do basic authentication.

> `has_secure_password` API: [https://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html#method-i-has_secure_password](https://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html#method-i-has_secure_password)
>
> `generates_token_for` API: [https://api.rubyonrails.org/classes/ActiveRecord/TokenFor/ClassMethods.html#method-i-generates_token_for](https://api.rubyonrails.org/classes/ActiveRecord/TokenFor/ClassMethods.html#method-i-generates_token_for)
>
> Add basic authentication generator PR `rails#50446`: [https://github.com/rails/rails/issues/50446](https://github.com/rails/rails/issues/50446)
>
> Add a default password reset token to has_secure_password PR `rails#52483`ï¼š[https://github.com/rails/rails/pull/52483](https://github.com/rails/rails/pull/52483)
>
> Generate magic tokens in Rails with generates_token_for: [https://blog.siami.fr/generate-magic-tokens-in-rails](https://blog.siami.fr/generate-magic-tokens-in-rails)